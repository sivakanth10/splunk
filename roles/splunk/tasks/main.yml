---
- name: Check if splunk is already installed
  yum: name=splunk state=present
  register: splunk_installed_result
  ignore_errors: yes

- name: Check if Splunk is running
  shell: /opt/splunk/bin/splunk status
  register: splunk_running
  ignore_errors: yes

- name: Stop splunk service
  shell: /opt/splunk/bin/splunk stop
  register: splunk_stop
  ignore_errors: yes
  
- name: Curl the package CentOS/Red Hat Enterprise Linux
  get_url:
    url: "{{ splunk_package_file_name }}"
    dest: "{{ splunk_installation_temp_path }}"
    mode: "0755" 
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
   
  
#commented this task 
#- name: uploading splunk installation package
#  copy: src="{{ splunk_file_path }}/{{ splunk_package_file_name }}"
#  dest= "{{ splunk_installation_temp_path }}/{{ splunk_version_name }}"
        
- name: Check that Splunk installer binary exists for CentOS/Red Hat Enterprise Linux
  stat: path="{{ splunk_installation_temp_path }}/{{ splunk_version_name }}"
  register: splunk_installer_present
 # when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  when: splunk_version_name_format == "rpm"
  
- name: Install Splunk server package for CentOS/Red Hat Enterprise Linux
  yum: pkg="{{ splunk_installation_temp_path }}/{{ splunk_version_name }}" state=installed
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
 
- name: Curl the package Debian/Ubuntu
  get_url:
    url: "{{ splunk_package_file_name_for_Debian }}"
    dest: "{{ splunk_installation_temp_path }}"
    mode: "0755" 
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
 
- name: Check that Splunk installer binary exists for Debian/Ubuntu
  stat: path="{{ splunk_installation_temp_path }}/{{ splunk_version_name_for_Debian }}"
  register: splunk_installer_present
 # when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  when: splunk_version_name_for_Debian_format == "deb"

- name: Install Splunk server package for Debian/Ubuntu
  apt: deb="{{ splunk_installation_temp_path }}/{{ splunk_version_name_for_Debian }}" state=installed  
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Starting splunk service
  shell: /opt/splunk/bin/splunk start --accept-license --answer-yes
  register: splunk_start
  ignore_errors: yes
  
- name: Set auto start after every boot
  shell: /opt/splunk/bin/splunk enable boot-start

#- name: Deletion of Splunk server installation package
#  shell: rm -rf /"{{ splunk_installation_temp_path }}/{{ splunk_version_name }}"
#  when: splunk_installer_present.stat.exists == true

#- name: Deletion of Splunk server installation package
#  shell: rm -rf /"{{ splunk_installation_temp_path }}/{{ splunk_version_name_for_Debian }}"
#  when: splunk_installer_present.stat.exists == true

